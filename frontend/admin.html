<!doctype html>
<html lang="hr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Landsky Cocktail Catering ‚Äì Admin</title>
  <link rel="icon" href="/frontend/favicon.ico" />
  <link rel="apple-touch-icon" href="/frontend/apple-touch-icon.png" />
  <style>
    :root{
      --bg:#0b0f14;
      --panel:rgba(255,255,255,.06);
      --stroke:rgba(255,255,255,.14);
      --text:#e8eef7;
      --muted:rgba(255,255,255,.65);
      --gold:#d7b46a;
      --ok:#32d296;
      --bad:#ff5a5f;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:var(--text);
      background:linear-gradient(180deg,#0b0f14,#101826);
      padding:22px;
    }
    h1{margin:0 0 6px 0}
    .sub{margin:0 0 14px 0; color:var(--muted); font-size:13px}
    .bar{
      display:flex; gap:10px; flex-wrap:wrap;
      align-items:center;
      padding:12px;
      border:1px solid var(--stroke);
      background:var(--panel);
      border-radius:14px;
      margin-bottom:14px;
    }
    label{color:var(--muted); font-size:12px}
    select,input{
      padding:10px 10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(0,0,0,.25);
      color:var(--text);
      outline:none;
      min-width: 180px;
    }
    button{
      padding:10px 12px;
      border-radius:12px;
      border:0;
      cursor:pointer;
      background:#1b2333;
      color:var(--text);
      border:1px solid rgba(255,255,255,.12);
    }
    button.primary{background:linear-gradient(180deg,var(--gold),#b8933f); color:#111; font-weight:700}
    button.bad{border-color:rgba(255,90,95,.4)}
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border:1px solid var(--stroke);
      border-radius:14px;
      background:rgba(0,0,0,.18);
    }
    thead th{
      text-align:left;
      font-size:12px;
      color:var(--muted);
      padding:12px;
      border-bottom:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.04);
      white-space:nowrap;
    }
    tbody td{
      padding:12px;
      border-bottom:1px solid rgba(255,255,255,.08);
      vertical-align:top;
      font-size:13px;
    }
    .pill{
      display:inline-block;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
    }
    .pill.ok{border-color:rgba(50,210,150,.35); color:#b7ffdf}
    .pill.bad{border-color:rgba(255,90,95,.35); color:#ffd0d1}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:12px}
.ellipsis{white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
.nowrap{white-space:nowrap}

    a{color:#8bd6ff}
    .actions{display:flex; gap:8px; flex-wrap:nowrap; align-items:center; white-space:nowrap}
.actions button{padding:6px 10px; font-size:12px; border-radius:10px}
.actions form{margin:0}
    .muted{color:var(--muted); font-size:12px}
    .nowrap{white-space:nowrap}
  </style>
</head>
<body>
  <h1>Landsky Cocktail Catering ‚Äì Admin</h1>
  <p class="sub">Pregled upita i promjena statusa (Basic Auth).</p>

  <div class="bar">
    <label for="status">Status</label>
    <select id="status">
      <option value="">Svi</option>
      <option value="pending">pending</option>
      <option value="accepted">accepted</option>
      <option value="declined">declined</option>
    </select>

    <label for="q">Pretraga (ime/email)</label>
    <input id="q" placeholder="npr. ivo ili gmail.com" />

    <label for="date-sort">Datum (A-Z)</label>
    <select id="date-sort">
      <option value="asc">A-Z (najraniji prvo)</option>
      <option value="desc">Z-A (najkasniji prvo)</option>
    </select>

    <label for="id-sort">ID</label>
    <select id="id-sort">
      <option value="">Prema datumu</option>
      <option value="asc">ID uzlazno</option>
      <option value="desc">ID silazno</option>
    </select>

    <button class="primary" id="refresh">Osvje≈æi</button>
    <button class="bad" id="logout">Odjava</button>

    <span id="msg" class="muted"></span>
  </div>

  <table>
    <thead>
      <tr>
        <th style="width:60px;">ID</th>
        <th style="width:120px;">Status</th>
        <th style="width:180px;">Klijent</th>
        <th style="width:120px;">Datum</th>
        <th style="width:220px;">Lokacija</th>
        <th style="width:90px;">Gosti</th>
        <th style="width:260px;">Kontakt</th>
        <th style="width:120px;">Paket</th>
        <th style="width:80px;">Podsjetnici</th>
        <th style="width:170px;">Zadnji email</th>
        <th style="width:170px;">Sljedeƒái podsjetnik</th>
        <th style="width:220px;">Token / link</th>
        <th style="width:320px;">Akcije</th>
      </tr>
    </thead>
    <tbody id="tbody">
      <tr><td colspan="13" class="muted" style="padding:18px;">Uƒçitavanje...</td></tr>
    </tbody>
  </table>

<script>
  const tbody = document.getElementById('tbody');
  const statusEl = document.getElementById('status');
  const qEl = document.getElementById('q');
  const dateSortEl = document.getElementById('date-sort');
  const idSortEl = document.getElementById('id-sort');
  const msgEl = document.getElementById('msg');

  function escapeHtml(s){
    return (s || '').replace(/[&<>"']/g, (c)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]));
  }

  function statusPill(status){
    if(status === 'accepted') return `<span class="pill ok">accepted</span>`;
    if(status === 'declined') return `<span class="pill bad">declined</span>`;
    return `<span class="pill">pending</span>`;
  }

  async function apiJson(path, opts={}){
    const controller = new AbortController();
    const t = setTimeout(() => controller.abort(), 20000);
    const res = await fetch(path, {credentials:'same-origin', ...opts, signal: controller.signal});
    clearTimeout(t);
    if(res.status === 401){ throw new Error('401 Unauthorized (Basic Auth)'); }
    if(!res.ok){
      const t = await res.text();
      throw new Error(t || ('HTTP '+res.status));
    }
    return await res.json();
  }

  async function apiNoJson(path, opts={}){
    const controller = new AbortController();
    const t = setTimeout(() => controller.abort(), 20000);
    const res = await fetch(path, {credentials:'same-origin', ...opts, signal: controller.signal});
    clearTimeout(t);
    if(res.status === 401){ throw new Error('401 Unauthorized (Basic Auth)'); }
    if(!res.ok){
      const t = await res.text();
      throw new Error(t || ('HTTP '+res.status));
    }
  }

  function render(items){
    if(!items.length){
      tbody.innerHTML = `<tr><td colspan="13" class="muted" style="padding:18px;">Nema rezultata.</td></tr>`;
      return;
    }
    tbody.innerHTML = items.map(e => {
      const fullName = `${escapeHtml(e.first_name)} ${escapeHtml(e.last_name)}`;
      const note = (e.message || '').trim();
      const contact = `
        <div class="nowrap ellipsis" title="${escapeHtml(e.email)}"><b>${escapeHtml(e.email)}</b></div>
        <div class="nowrap muted" title="${escapeHtml(e.phone || '')}">${escapeHtml(e.phone || '')}</div>
        ${note ? `<div class="muted nowrap" title="Napomena: ${escapeHtml(note)}">üìù</div>` : ``}
      `;
      const pkg = (e.selected_package || '').trim();
      const pkgHtml = pkg ? `<span class="pill">${escapeHtml(pkg)}</span>` : `<span class="pill" style="opacity:.7">‚Äî</span>`;
	      const token = e.token || '';
      const tokenShort = token ? (token.slice(0,10) + '‚Ä¶') : '';
      const tokenLink = `
        <div class="mono nowrap" title="${escapeHtml(token)}">${escapeHtml(tokenShort)}</div>
        <div class="nowrap"><a href="/offer-preview?token=${encodeURIComponent(token)}" target="_blank" rel="noopener">Preview</a></div>
      `;
	      const sendReminderBtn = e.next_reminder_kind
	        ? `<button onclick="sendReminderNow(${e.id})">Send reminder</button>`
	        : ``;

	      return `
        <tr>
          <td>${e.id}</td>
          <td>${statusPill(e.status)}</td>
          <td>${fullName}</td>
          <td class="nowrap">${escapeHtml(e.wedding_date)}</td>
          <td>${escapeHtml(e.venue)}</td>
          <td>${e.guest_count}</td>
          <td>${contact}</td>
<td>${pkgHtml}</td>
<td class="nowrap">${(e.reminder_count ?? 0)}</td>
<td class="nowrap">${escapeHtml(e.last_email_sent_at || '‚Äî')}</td>
<td>
  ${e.next_reminder_due ? `<div class="nowrap">${escapeHtml(e.next_reminder_due)}</div><div class="muted" style="font-size:12px;">${escapeHtml(e.next_reminder_kind||'')}</div>` : `<span class="muted">‚Äî</span>`}
</td>
<td>${tokenLink}</td>
<td>
  <div class="actions">
	    <button onclick="setStatus(${e.id}, 'accepted')">Accept</button>
	    <button onclick="declineEvent(${e.id})">Decline</button>
	    <button onclick="setStatus(${e.id}, 'pending')">Pending</button>
	    <button onclick="resendOffer(${e.id})">Resend</button>
	    ${sendReminderBtn}
        <button onclick="openLogs(${e.id})">Logs</button>
	  </div>
          </td>
        </tr>
      `;
    }).join('');
  }

  async function load(){
    msgEl.textContent = 'Uƒçitavanje...';
    const s = statusEl.value;
    const q = (qEl.value || '').trim();
    const dateSort = dateSortEl.value;
    const idSort = idSortEl.value;
    const url = new URL('/admin/api/events', location.origin);
    if(s) url.searchParams.set('status', s);
    if(q) url.searchParams.set('q', q);
    if(dateSort) url.searchParams.set('date_sort', dateSort);
    if(idSort) url.searchParams.set('id_sort', idSort);

    try{
      const data = await apiJson(url.pathname + url.search);
      const items = data.items || [];
      render(items);
      msgEl.textContent = `Uƒçitano: ${items.length}`;
    }catch(err){
      tbody.innerHTML = `<tr><td colspan="13" style="color:#ffd0d1; padding:18px;">Gre≈°ka: ${escapeHtml(String(err))}</td></tr>`;
      msgEl.textContent = '';
    }
  }

  async function setStatus(id, status){
    if(!confirm(`Postavi status "${status}" za ID ${id}?`)) return;
    await apiJson(`/admin/api/events/${id}/status`, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({status})
    });
    await load();
  }

  async function acceptEvent(id){
    if(!confirm(`Accept za ID ${id}?`)) return;
    await apiJson(`/admin/api/events/${id}/accept`, { method:'POST' });
    await load();
  }

  async function declineEvent(id){
    const text = prompt(`Za potvrdu upi≈°ite DECLINE (ID ${id})`);
    if(text === null) return;
    await apiJson(`/admin/api/events/${id}/decline`, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({confirm_text: text})
    });
    await load();
  }

  async function resendOffer(id){
    if(!confirm('Resend offer email?')) return;
    await apiJson(`/admin/api/events/${id}/resend`, { method:'POST' });
    await load();
    alert('Resend OK');
  }



async function openLogs(id){
  try{
    const data = await apiJson(`/admin/api/events/${id}/email-logs`);
    const w = window.open('', '_blank');
    if(!w){
      alert('Popup blocked');
      return;
    }
    const safe = JSON.stringify(data, null, 2)
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;');

    w.document.write(`
      <!doctype html>
      <html>
      <head>
        <title>Email logs</title>
        <style>
          body{font-family:system-ui;padding:20px;background:#0b1220;color:#e5e7eb}
          pre{white-space:pre-wrap}
        </style>
      </head>
      <body>
        <h2>Email logs ‚Äî event ${id}</h2>
        <pre>${safe}</pre>
      </body>
      </html>
    `);
    w.document.close();
  }catch(err){
    alert('Gre≈°ka (logs): ' + (err?.message || err));
  }
}


async function sendReminderNow(id){
  if(!confirm('Send reminder now?')) return;
  await apiJson(`/admin/api/events/${id}/send-reminder-now`, { method:'POST' });
  await load();
  alert('Reminder sent (or already sent).');
}

  window.setStatus = setStatus;
  window.acceptEvent = acceptEvent;
  window.declineEvent = declineEvent;
  window.resendOffer = resendOffer;
  window.sendReminderNow = sendReminderNow;
  window.openLogs = openLogs;

  document.getElementById('refresh').addEventListener('click', load);
  document.getElementById('logout').addEventListener('click', async () => {
    try{ await apiNoJson('/admin/logout', {method:'POST'}); }catch(e){}
    location.reload();
  });

  qEl.addEventListener('keydown', (ev) => { if(ev.key === 'Enter') load(); });
  statusEl.addEventListener('change', load);
  dateSortEl.addEventListener('change', load);
  idSortEl.addEventListener('change', load);

  load();
</script>
</body>
</html>
