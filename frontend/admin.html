<!doctype html>
<html lang="hr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Landsky Admin</title>
  <style>
    :root{
      --bg:#0b0f14;
      --panel:rgba(255,255,255,.06);
      --stroke:rgba(255,255,255,.14);
      --text:#e8eef7;
      --muted:rgba(255,255,255,.65);
      --gold:#d7b46a;
      --ok:#32d296;
      --bad:#ff5a5f;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:var(--text);
      background:linear-gradient(180deg,#0b0f14,#101826);
      padding:22px;
    }
    h1{margin:0 0 6px 0}
    .sub{margin:0 0 14px 0; color:var(--muted); font-size:13px}
    .bar{
      display:flex; gap:10px; flex-wrap:wrap;
      align-items:center;
      padding:12px;
      border:1px solid var(--stroke);
      background:var(--panel);
      border-radius:14px;
      margin-bottom:14px;
    }
    label{color:var(--muted); font-size:12px}
    select,input{
      padding:10px 10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(0,0,0,.25);
      color:var(--text);
      outline:none;
      min-width: 180px;
    }
    button{
      padding:10px 12px;
      border-radius:12px;
      border:0;
      cursor:pointer;
      background:#1b2333;
      color:var(--text);
      border:1px solid rgba(255,255,255,.12);
    }
    button.primary{background:linear-gradient(180deg,var(--gold),#b8933f); color:#111; font-weight:700}
    button.bad{border-color:rgba(255,90,95,.4)}
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border:1px solid var(--stroke);
      border-radius:14px;
      background:rgba(0,0,0,.18);
    }
    thead th{
      text-align:left;
      font-size:12px;
      color:var(--muted);
      padding:12px;
      border-bottom:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.04);
      white-space:nowrap;
    }
    tbody td{
      padding:12px;
      border-bottom:1px solid rgba(255,255,255,.08);
      vertical-align:top;
      font-size:13px;
    }
    .pill{
      display:inline-block;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
    }
    .pill.ok{border-color:rgba(50,210,150,.35); color:#b7ffdf}
    .pill.bad{border-color:rgba(255,90,95,.35); color:#ffd0d1}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:12px}
    a{color:#8bd6ff}
    .actions{display:flex; gap:8px; flex-wrap:wrap}
    .muted{color:var(--muted); font-size:12px}
    .nowrap{white-space:nowrap}
  </style>
</head>
<body>
  <h1>Landsky Admin</h1>
  <p class="sub">Pregled upita i promjena statusa (Basic Auth).</p>

  <div class="bar">
    <label for="status">Status</label>
    <select id="status">
      <option value="">Svi</option>
      <option value="pending">pending</option>
      <option value="accepted">accepted</option>
      <option value="declined">declined</option>
    </select>

    <label for="q">Pretraga (ime/email)</label>
    <input id="q" placeholder="npr. ivo ili gmail.com" />

    <button class="primary" id="refresh">Osvježi</button>
    <button class="bad" id="logout">Odjava</button>

    <span id="msg" class="muted"></span>
  </div>

  <table>
    <thead>
      <tr>
        <th style="width:60px;">ID</th>
        <th style="width:120px;">Status</th>
        <th style="width:180px;">Mladenci</th>
        <th style="width:120px;">Datum</th>
        <th style="width:220px;">Lokacija</th>
        <th style="width:90px;">Gosti</th>
        <th style="width:260px;">Kontakt</th>
        <th style="width:120px;">Paket</th>
        <th style="width:220px;">Token / link</th>
        <th style="width:260px;">Akcije</th>
      </tr>
    </thead>
    <tbody id="tbody">
      <tr><td colspan="10" class="muted" style="padding:18px;">Učitavanje...</td></tr>
    </tbody>
  </table>

<script>
  const tbody = document.getElementById('tbody');
  const statusEl = document.getElementById('status');
  const qEl = document.getElementById('q');
  const msgEl = document.getElementById('msg');

  function escapeHtml(s){
    return (s || '').replace(/[&<>"']/g, (c)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]));
  }

  function statusPill(status){
    if(status === 'accepted') return `<span class="pill ok">accepted</span>`;
    if(status === 'declined') return `<span class="pill bad">declined</span>`;
    return `<span class="pill">pending</span>`;
  }

  async function apiJson(path, opts={}){
    const res = await fetch(path, opts);
    if(res.status === 401){
      throw new Error('401 Unauthorized (Basic Auth)');
    }
    if(!res.ok){
      const t = await res.text();
      throw new Error(t || ('HTTP '+res.status));
    }
    return await res.json();
  }

  async function apiNoJson(path, opts={}){
    const res = await fetch(path, opts);
    if(res.status === 401){
      throw new Error('401 Unauthorized (Basic Auth)');
    }
    if(!res.ok){
      const t = await res.text();
      throw new Error(t || ('HTTP '+res.status));
    }
  }

  function render(items){
    if(!items.length){
      tbody.innerHTML = `<tr><td colspan="10" class="muted" style="padding:18px;">Nema rezultata.</td></tr>`;
      return;
    }

    tbody.innerHTML = items.map(e => {
      const fullName = `${escapeHtml(e.first_name)} ${escapeHtml(e.last_name)}`;
      const contact = `
        <div><b>${escapeHtml(e.email)}</b></div>
        <div class="muted">${escapeHtml(e.phone)}</div>
        <div style="margin-top:8px" class="muted">
          <b>Napomena:</b><br>${escapeHtml((e.message || '')).slice(0,180)}${(e.message||'').length>180?'…':''}
        </div>
      `;

      const pkg = (e.selected_package || '').trim();
      const pkgHtml = pkg ? `<span class="pill">${escapeHtml(pkg)}</span>` : `<span class="pill" style="opacity:.7">—</span>`;

      const token = e.token || '';
      const tokenLink = `
        <div class="mono">${escapeHtml(token)}</div>
        <div class="nowrap"><a href="/offer-preview?token=${encodeURIComponent(token)}" target="_blank" rel="noopener">Preview</a></div>
      `;

      return `
        <tr>
          <td>${e.id}</td>
          <td>${statusPill(e.status)}</td>
          <td>${fullName}</td>
          <td class="nowrap">${escapeHtml(e.wedding_date)}</td>
          <td>${escapeHtml(e.venue)}</td>
          <td>${e.guest_count}</td>
          <td>${contact}</td>
          <td>${pkgHtml}</td>
          <td>${tokenLink}</td>
          <td>
            <div class="actions">
              <button onclick="acceptEvent(${e.id})">Accept</button>
              <button onclick="declineEvent(${e.id})">Decline</button>
              <button onclick="setStatus(${e.id}, 'pending')">Pending</button>
              <button onclick="resendOffer(${e.id})">Resend</button>
            </div>
          </td>
        </tr>
      `;
    }).join('');
  }

  async function load(){
    msgEl.textContent = 'Učitavanje...';

    const s = statusEl.value;
    const q = (qEl.value || '').trim();
    const url = new URL('/admin/api/events', location.origin);
    if(s) url.searchParams.set('status', s);
    if(q) url.searchParams.set('q', q);

    try{
      const data = await apiJson(url.toString());
      const items = data.items || [];
      render(items);
      msgEl.textContent = `Učitano: ${items.length}`;
    }catch(err){
      tbody.innerHTML = `<tr><td colspan="10" style="color:#ffd0d1; padding:18px;">Greška: ${escapeHtml(String(err))}</td></tr>`;
      msgEl.textContent = '';
    }
  }

  async function setStatus(id, status){
    if(!confirm(`Postavi status "${status}" za ID ${id}?`)) return;
    try{
      await apiJson(`/admin/api/events/${id}/status`, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({status})
      });
      await load();
    }catch(err){
      alert(String(err));
    }
  }

  // OLD endpoints support (accept/decline)
  async function acceptEvent(id){
    if(!confirm(`Accept za ID ${id}?`)) return;
    try{
      await apiJson(`/admin/api/events/${id}/accept`, { method:'POST' });
      await load();
    }catch(err){
      alert(String(err));
    }
  }

  async function declineEvent(id){
    if(!confirm(`Decline za ID ${id}?`)) return;
    try{
      await apiJson(`/admin/api/events/${id}/decline`, { method:'POST' });
      await load();
    }catch(err){
      alert(String(err));
    }
  }

  async function resendOffer(id){
    if(!confirm('Resend offer email?')) return;
    try{
      await apiJson(`/admin/api/events/${id}/resend`, { method:'POST' });
      await load();
      alert('Resend OK');
    }catch(err){
      alert(String(err));
    }
  }

  // Expose for inline onclick
  window.setStatus = setStatus;
  window.acceptEvent = acceptEvent;
  window.declineEvent = declineEvent;
  window.resendOffer = resendOffer;

  document.getElementById('refresh').addEventListener('click', load);
  document.getElementById('logout').addEventListener('click', async () => {
    try{ await apiNoJson('/admin/logout', {method:'POST'}); }catch(e){}
    location.reload();
  });

  qEl.addEventListener('keydown', (ev) => { if(ev.key === 'Enter') load(); });
  statusEl.addEventListener('change', load);

  load();
</script>
</body>
</html>
