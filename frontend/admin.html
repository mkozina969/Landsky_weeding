<!doctype html>
<html lang="hr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Landsky Cocktail Catering ‚Äì Admin</title>
  <link rel="icon" href="/frontend/favicon.ico" />

  <style>
    :root{
      --bg:#0b1220;
      --panel:rgba(255,255,255,.06);
      --border:rgba(255,255,255,.12);
      --muted:#9ca3af;
      --text:#e5e7eb;
      --pill:rgba(148,163,184,.12);
    }

    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: var(--bg);
      color: var(--text);
      margin: 0;
      padding: 18px;
    }

    .bar{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      margin-bottom:12px;
    }

    .controls{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }

    select, input{
      background: rgba(255,255,255,.04);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 9px 10px;
      outline: none;
    }

    button{
      background: rgba(255,255,255,.06);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 9px 12px;
      cursor:pointer;
    }
    button:hover{ background: rgba(255,255,255,.10); }

    table{
      width:100%;
      border-collapse: collapse;
      table-layout: fixed;
      background: var(--panel);
      border:1px solid var(--border);
      border-radius: 16px;
      overflow:hidden;
    }
    th, td{
      border-bottom:1px solid rgba(255,255,255,.08);
      padding: 10px 8px;
      vertical-align: middle;
    }
    th{
      text-align:left;
      font-size: 12px;
      color: var(--muted);
      font-weight:700;
      letter-spacing:.02em;
      background: rgba(0,0,0,.15);
    }
    tr:hover td{ background: rgba(255,255,255,.03); }

    .muted{ color: var(--muted); }
    .nowrap{ white-space: nowrap; }
    .ellipsis{ white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 12px; }

    .pill{
      display:inline-block;
      padding: 3px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: var(--pill);
      font-size: 12px;
    }

    .actions{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:nowrap;
      white-space: nowrap;
    }
    .actions button{
      padding:6px 10px;
      font-size: 12px;
      border-radius: 10px;
    }

    a{ color:#93c5fd; text-decoration:none; }
    a:hover{ text-decoration:underline; }
  </style>
</head>

<body>
  <div class="bar">
    <div>
      <div class="muted" style="font-size:12px;">Admin</div>
      <h2 style="margin:2px 0 0;">Upiti & ponude</h2>
    </div>
    <div id="msg" class="muted">‚Äî</div>
  </div>

  <div class="controls" style="margin-bottom:12px;">
    <label class="muted">Status:</label>
    <select id="status">
      <option value="">Svi</option>
      <option value="pending">Pending</option>
      <option value="accepted">Accepted</option>
      <option value="declined">Declined</option>
    </select>

    <label class="muted">Pretraga:</label>
    <input id="q" placeholder="Ime / prezime / email" />

    <button onclick="load()">Refresh</button>
  </div>

  <table>
    <thead>
      <tr>
        <th style="width:60px;">ID</th>
        <th style="width:120px;">Status</th>
        <th style="width:110px;">Tip</th>
        <th style="width:180px;">Klijent</th>
        <th style="width:120px;">Datum</th>
        <th style="width:220px;">Lokacija</th>
        <th style="width:90px;">Gosti</th>
        <th style="width:260px;">Kontakt</th>
        <th style="width:120px;">Paket</th>
        <th style="width:80px;">Podsjetnici</th>
        <th style="width:170px;">Zadnji email</th>
        <th style="width:170px;">Sljedeƒái podsjetnik</th>
        <th style="width:220px;">Token / link</th>
        <th style="width:360px;">Akcije</th>
      </tr>
    </thead>
    <tbody id="tbody">
      <tr><td colspan="14" class="muted" style="padding:18px;">Uƒçitavanje‚Ä¶</td></tr>
    </tbody>
  </table>

<script>
  const tbody = document.getElementById('tbody');
  const statusEl = document.getElementById('status');
  const qEl = document.getElementById('q');
  const msgEl = document.getElementById('msg');

  function escapeHtml(s){
    return String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;');
  }

  async function apiJson(url, opts){
    const ctrl = new AbortController();
    const t = setTimeout(() => ctrl.abort(), 20000);
    try{
      const res = await fetch(url, {credentials:'same-origin', signal: ctrl.signal, ...opts});
      if(!res.ok){
        throw new Error(await res.text());
      }
      return await res.json();
    } finally {
      clearTimeout(t);
    }
  }

  function statusPill(status){
    const s = (status||'').toLowerCase();
    let bg = 'rgba(148,163,184,.12)';
    let br = 'rgba(255,255,255,.10)';
    let col = '#e5e7eb';
    if(s==='accepted'){ bg='rgba(34,197,94,.14)'; br='rgba(34,197,94,.28)'; col='#bbf7d0'; }
    if(s==='declined'){ bg='rgba(239,68,68,.14)'; br='rgba(239,68,68,.28)'; col='#fecaca'; }
    return `<span class="pill" style="background:${bg};border-color:${br};color:${col}">${escapeHtml(s||'‚Äî')}</span>`;
  }

  function eventTypePill(e){
    const t = (e.event_type || 'wedding').toLowerCase();
    const labelMap = {wedding:'Wedding', corporate:'Corporate', private:'Private'};
    const label = labelMap[t] || (t.charAt(0).toUpperCase()+t.slice(1));
    let extra = '';
    if(e.is_expired){
      extra = ' <span class="pill" style="background:rgba(239,68,68,.18);border-color:rgba(239,68,68,.35);color:#fecaca">EXPIRED</span>';
    }
    return `<span class="pill">${escapeHtml(label)}</span>${extra}`;
  }

  function render(items){
    if(!items.length){
      tbody.innerHTML = `<tr><td colspan="14" class="muted" style="padding:18px;">Nema rezultata.</td></tr>`;
      return;
    }
    tbody.innerHTML = items.map(e => {
      const fullName = `${escapeHtml(e.first_name)} ${escapeHtml(e.last_name)}`;
      const note = (e.message || '').trim();
      const contact = `
        <div class="nowrap ellipsis" title="${escapeHtml(e.email)}"><b>${escapeHtml(e.email)}</b></div>
        <div class="nowrap muted" title="${escapeHtml(e.phone || '')}">${escapeHtml(e.phone || '')}</div>
        ${note ? `<div class="muted nowrap" title="Napomena: ${escapeHtml(note)}">üìù</div>` : ``}
      `;
      const pkg = (e.selected_package || '').trim();
      const pkgHtml = pkg ? `<span class="pill">${escapeHtml(pkg)}</span>` : `<span class="pill" style="opacity:.7">‚Äî</span>`;
      const token = e.token || '';
      const tokenShort = token ? (token.slice(0,10) + '‚Ä¶') : '';
      const tokenLink = `
        <div class="mono nowrap" title="${escapeHtml(token)}">${escapeHtml(tokenShort)}</div>
        <div class="nowrap"><a href="/offer-preview?token=${encodeURIComponent(token)}" target="_blank" rel="noopener">Preview</a></div>
      `;
      const sendReminderBtn = e.next_reminder_kind
        ? `<button onclick="sendReminderNow(${e.id})">Send reminder</button>`
        : ``;

      return `
        <tr>
          <td>${e.id}</td>
          <td>${statusPill(e.status)}</td>
          <td>${eventTypePill(e)}</td>
          <td>${fullName}</td>
          <td class="nowrap">${escapeHtml(e.wedding_date)}</td>
          <td>${escapeHtml(e.venue)}</td>
          <td>${e.guest_count}</td>
          <td>${contact}</td>
          <td>${pkgHtml}</td>
          <td class="nowrap">${(e.reminder_count ?? 0)}</td>
          <td class="nowrap">${escapeHtml(e.last_email_sent_at || '‚Äî')}</td>
          <td>
            ${e.next_reminder_due ? `<div class="nowrap">${escapeHtml(e.next_reminder_due)}</div><div class="muted" style="font-size:12px;">${escapeHtml(e.next_reminder_kind||'')}</div>` : `<span class="muted">‚Äî</span>`}
          </td>
          <td>${tokenLink}</td>
          <td>
            <div class="actions">
              <button onclick="setStatus(${e.id}, 'accepted')">Accept</button>
              <button onclick="setStatus(${e.id}, 'declined')">Decline</button>
              <button onclick="setStatus(${e.id}, 'pending')">Pending</button>
              <button onclick="resendOffer(${e.id})">Resend</button>
              ${sendReminderBtn}
              <button onclick="openTimeline(${e.id})">Timeline</button>
              <button onclick="openLogs(${e.id})">Logs</button>
            </div>
          </td>
        </tr>
      `;
    }).join('');
  }

  async function load(){
    msgEl.textContent = 'Uƒçitavanje...';
    const s = statusEl.value;
    const q = (qEl.value || '').trim();
    const url = new URL('/admin/api/events', location.origin);
    if(s) url.searchParams.set('status', s);
    if(q) url.searchParams.set('q', q);

    try{
      const data = await apiJson(url.pathname + url.search);
      const items = data.items || [];
      render(items);
      msgEl.textContent = `Uƒçitano: ${items.length}`;
    }catch(err){
      tbody.innerHTML = `<tr><td colspan="14" style="color:#ffd0d1; padding:18px;">Gre≈°ka: ${escapeHtml(String(err))}</td></tr>`;
      msgEl.textContent = 'Gre≈°ka';
    }
  }

  async function setStatus(id, status){
    await apiJson(`/admin/api/events/${id}/status`,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({status})
    });
    load();
  }

  async function resendOffer(id){
    await apiJson(`/admin/api/events/${id}/resend`, {method:'POST'});
    load();
  }

  async function sendReminderNow(id){
    await apiJson(`/admin/api/events/${id}/send-reminder-now`, {method:'POST'});
    load();
  }

  async function openLogs(id){
    try{
      const data = await apiJson(`/admin/api/events/${id}/email-logs`);
      const w = window.open('', '_blank');
      if(!w){ alert('Popup blocked'); return; }

      const safe = JSON.stringify(data,null,2).replace(/</g,'&lt;').replace(/>/g,'&gt;');
      w.document.write(`
        <!doctype html>
        <html>
        <head>
          <title>Email logs</title>
          <style>
            body{font-family:system-ui;padding:20px;background:#0b1220;color:#e5e7eb}
            pre{white-space:pre-wrap}
          </style>
        </head>
        <body>
          <h2>Email logs ‚Äî event ${id}</h2>
          <pre>${safe}</pre>
        </body>
        </html>
      `);
      w.document.close();
    }catch(err){
      alert('Gre≈°ka (logs): ' + (err?.message || err));
    }
  }

  // Timeline modal (email + notes)
  let currentTimelineEventId = null;

  function closeTimeline(){
    document.getElementById('timelineModal').style.display = 'none';
    currentTimelineEventId = null;
    document.getElementById('timelineBody').innerHTML = '';
    document.getElementById('noteText').value = '';
  }

  async function openTimeline(id){
    currentTimelineEventId = id;
    document.getElementById('timelineTitle').textContent = `Event #${id}`;
    document.getElementById('timelineBody').innerHTML = '<div class="muted" style="padding:10px 0;">Uƒçitavanje‚Ä¶</div>';
    document.getElementById('timelineModal').style.display = 'flex';
    await refreshTimeline();
  }

  async function refreshTimeline(){
    if(!currentTimelineEventId) return;
    const items = await apiJson(`/admin/api/events/${currentTimelineEventId}/timeline`);
    const body = document.getElementById('timelineBody');

    if(!items.length){
      body.innerHTML = '<div class="muted" style="padding:10px 0;">Nema aktivnosti.</div>';
      return;
    }

    body.innerHTML = items.map(it => {
      const when = it.created_at ? escapeHtml(it.created_at) : '';
      if(it.type === 'note'){
        return `<div style="padding:10px 12px; border:1px solid rgba(255,255,255,.10); border-radius:14px; margin-bottom:10px; background:rgba(255,255,255,.04);">
          <div class="muted" style="font-size:12px;">üìù Note ‚Ä¢ ${when}</div>
          <div style="margin-top:6px; white-space:pre-wrap;">${escapeHtml(it.label || '')}</div>
        </div>`;
      }
      const st = it.status ? ` ‚Ä¢ ${escapeHtml(it.status)}` : '';
      const subj = it.subject ? `<div class="muted" style="margin-top:4px;">${escapeHtml(it.subject)}</div>` : '';
      return `<div style="padding:10px 12px; border:1px solid rgba(255,255,255,.10); border-radius:14px; margin-bottom:10px; background:rgba(255,255,255,.03);">
        <div class="muted" style="font-size:12px;">‚úâÔ∏è Email${st} ‚Ä¢ ${when}</div>
        <div style="margin-top:6px;">${escapeHtml(it.label || '')}</div>
        ${subj}
      </div>`;
    }).join('');
  }

  async function addNote(){
    const text = (document.getElementById('noteText').value || '').trim();
    if(!text) return;
    await apiJson(`/admin/api/events/${currentTimelineEventId}/notes`,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({text})
    });
    document.getElementById('noteText').value = '';
    await refreshTimeline();
  }

  load();
</script>

<!-- Timeline modal -->
<div id="timelineModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.6); z-index:9999; align-items:center; justify-content:center;">
  <div style="width:min(920px,92vw); max-height:85vh; overflow:auto; background:#0b1220; border:1px solid rgba(255,255,255,.14); border-radius:16px; padding:16px;">
    <div style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
      <div>
        <div class="muted" style="font-size:12px;">Timeline</div>
        <h3 id="timelineTitle" style="margin:4px 0 0;">Event</h3>
      </div>
      <button onclick="closeTimeline()" style="padding:6px 10px;">Close</button>
    </div>

    <div style="margin-top:12px; display:flex; gap:10px; align-items:flex-start; flex-wrap:wrap;">
      <textarea id="noteText" placeholder="Dodaj internu bilje≈°ku‚Ä¶" rows="2" style="flex:1; min-width:280px; background:#0f172a; color:#e5e7eb; border:1px solid rgba(255,255,255,.14); border-radius:12px; padding:10px;"></textarea>
      <button onclick="addNote()" style="padding:10px 12px;">Add note</button>
    </div>

    <div id="timelineBody" style="margin-top:14px;"></div>
  </div>
</div>

</body>
</html>
