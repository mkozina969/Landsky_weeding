<!doctype html>
<html lang="hr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Landsky Admin</title>
  <style>
    body{font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin:0; padding:24px; background:#f6f7fb; color:#111;}
    h1{margin:0 0 6px}
    .sub{margin:0 0 18px; color:#555}
    .bar{display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-bottom:14px}
    select,input{padding:10px; border:1px solid #ddd; border-radius:10px}
    button{padding:10px 14px; border:1px solid #ddd; border-radius:10px; background:#fff; cursor:pointer}
    table{width:100%; border-collapse:collapse; background:#fff; border:1px solid #e5e7eb; border-radius:12px; overflow:hidden}
    th,td{padding:10px 10px; border-bottom:1px solid #f0f0f0; text-align:left; font-size:14px; vertical-align:top}
    th{background:#fafafa; font-size:12px; text-transform:uppercase; letter-spacing:.04em; color:#555}
    .pill{display:inline-block; padding:4px 10px; border-radius:999px; font-size:12px; border:1px solid #ddd}
    .pending{background:#fff7ed; border-color:#fed7aa}
    .accepted{background:#ecfdf5; border-color:#a7f3d0}
    .declined{background:#fef2f2; border-color:#fecaca}
    .muted{color:#666; font-size:12px}
    .actions{display:flex; gap:8px; flex-wrap:wrap}
    a{color:#2563eb}
    .empty{padding:14px; background:#fff; border:1px dashed #ddd; border-radius:12px; color:#555}
  </style>
</head>
<body>
  <h1>Landsky Admin</h1>
  <p class="sub">Pregled upita i promjena statusa (Basic Auth).</p>

  <div class="bar">
    <select id="status">
      <option value="">Svi</option>
      <option value="pending">pending</option>
      <option value="accepted">accepted</option>
      <option value="declined">declined</option>
    </select>
    <input id="q" placeholder="Pretraga (ime/email)" />
    <button id="refresh">Osvježi</button>
    <button id="logout">Odjava</button>
    <span class="muted" id="info"></span>
  </div>

  <div id="out"></div>

<script>
const out = document.getElementById('out');
const info = document.getElementById('info');

function esc(s){return (s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');}

async function load(){
  info.textContent='Učitavanje...';
  const status = document.getElementById('status').value;
  const q = document.getElementById('q').value;

  const url = new URL('/admin/api/events', window.location.origin);
  if(status) url.searchParams.set('status', status);
  if(q) url.searchParams.set('q', q);

  const res = await fetch(url);
  if(!res.ok){
    out.innerHTML = '<div class="empty">Greška: ' + res.status + '</div>';
    info.textContent='';
    return;
  }
  const data = await res.json();
  info.textContent = 'Ukupno: ' + data.length;

  if(!data.length){
    out.innerHTML = '<div class="empty">Nema zapisa.</div>';
    return;
  }

  let html = '<table><thead><tr>'
    + '<th>ID</th><th>Status</th><th>Mladenci</th><th>Datum</th><th>Lokacija</th><th>Kontakt</th><th>Paket</th><th>Token link</th><th>Akcije</th>'
    + '</tr></thead><tbody>';

  for(const e of data){
    const pill = '<span class="pill '+esc(e.status)+'">'+esc(e.status)+'</span>';
    const tokenLink = e.token ? ('<a href="/offer-preview?token='+encodeURIComponent(e.token)+'" target="_blank">preview</a>') : '';
    const pkg = e.selected_package ? esc(e.selected_package) : '<span class="muted">—</span>';

    html += '<tr>'
      + '<td>'+e.id+'</td>'
      + '<td>'+pill+'</td>'
      + '<td><b>'+esc(e.first_name)+' '+esc(e.last_name)+'</b></td>'
      + '<td>'+esc(e.wedding_date)+'</td>'
      + '<td>'+esc(e.venue)+'<div class="muted">gostiju: '+esc(String(e.guest_count))+'</div></td>'
      + '<td>'+esc(e.email)+'<div class="muted">'+esc(e.phone)+'</div></td>'
      + '<td>'+pkg+'</td>'
      + '<td>'+tokenLink+'</td>'
      + '<td class="actions">'
      + '<button onclick="setStatus('+e.id+',\'accepted\')">Accept</button>'
      + '<button onclick="setStatus('+e.id+',\'declined\')">Decline</button>'
      + '<button onclick="setStatus('+e.id+',\'pending\')">Pending</button>'
      + '</td>'
      + '</tr>';
  }
  html += '</tbody></table>';
  out.innerHTML = html;
}

async function setStatus(id, status){
  const res = await fetch('/admin/api/events/'+id+'/status', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({status})
  });
  if(!res.ok){
    alert('Greška: ' + res.status);
    return;
  }
  await load();
}

document.getElementById('refresh').addEventListener('click', load);
document.getElementById('logout').addEventListener('click', async () => {
  await fetch('/admin/logout', {method:'POST'});
  location.reload();
});
load();
</script>
</body>
</html>
