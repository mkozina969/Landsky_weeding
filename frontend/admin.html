<!DOCTYPE html>
<html lang="hr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Landsky Admin</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 24px; }
    h1 { margin: 0 0 6px 0; }
    .muted { color:#666; font-size: 13px; }
    .card { border:1px solid #ddd; border-radius: 10px; padding: 14px; margin-top: 14px; }
    .row { display:flex; gap: 12px; flex-wrap: wrap; align-items: end; }
    label { display:flex; flex-direction: column; gap: 6px; font-size: 14px; }
    input, select, button { padding: 8px; font-size: 14px; }
    button { cursor:pointer; }
    table { width:100%; border-collapse: collapse; margin-top: 12px; }
    th, td { border-bottom:1px solid #eee; padding:10px; text-align:left; vertical-align: top; }
    th { background:#fafafa; position: sticky; top: 0; }
    .pill { padding: 3px 8px; border-radius: 999px; font-size: 12px; display:inline-block; }
    .pending { background:#fff3cd; }
    .accepted { background:#d1e7dd; }
    .declined { background:#f8d7da; }
    .actions { display:flex; gap:8px; }
    .error { color:#b00020; }
    .ok { color:#0a7b34; }
    .small { font-size:12px; }
  </style>
</head>
<body>
  <h1>Landsky Admin</h1>
  <div class="muted">Pregled upita i promjena statusa (Basic Auth).</div>

  <div class="card">
    <div class="row">
      <label>
        Status
        <select id="status">
          <option value="">Svi</option>
          <option value="pending">pending</option>
          <option value="accepted">accepted</option>
          <option value="declined">declined</option>
        </select>
      </label>

      <label>
        Pretraga (ime/email)
        <input id="q" type="text" placeholder="npr. ivo ili gmail.com" />
      </label>

      <button id="refreshBtn">Osvježi</button>
      <button id="logoutBtn">Odjava</button>
    </div>

    <div id="msg" class="small" style="margin-top:10px;"></div>

    <div style="overflow:auto; max-height: 70vh;">
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Status</th>
            <th>Mladenci</th>
            <th>Datum</th>
            <th>Sala</th>
            <th>Gosti</th>
            <th>Kontakt</th>
            <th>Token link</th>
            <th>Akcije</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

<script>
  function setMsg(text, kind="") {
    const el = document.getElementById("msg");
    el.className = "small " + (kind === "error" ? "error" : kind === "ok" ? "ok" : "");
    el.textContent = text || "";
  }

  function pill(status) {
    const cls = status === "accepted" ? "accepted" : status === "declined" ? "declined" : "pending";
    return `<span class="pill ${cls}">${status}</span>`;
  }

  function getAuthHeader() {
    const raw = localStorage.getItem("admin_basic_auth");
    if (!raw) return null;
    return "Basic " + raw;
  }

  async function ensureAuth() {
    let raw = localStorage.getItem("admin_basic_auth");
    if (raw) return;

    const user = prompt("Admin username:");
    if (user === null) throw new Error("Cancelled");
    const pass = prompt("Admin password:");
    if (pass === null) throw new Error("Cancelled");

    raw = btoa(`${user}:${pass}`);
    localStorage.setItem("admin_basic_auth", raw);
  }

  async function apiFetch(path, options={}) {
    const auth = getAuthHeader();
    if (!auth) throw new Error("Not authenticated");

    const res = await fetch(path, {
      ...options,
      headers: {
        ...(options.headers || {}),
        "Authorization": auth,
        "Content-Type": "application/json",
      }
    });

    if (res.status === 401) {
      localStorage.removeItem("admin_basic_auth");
      throw new Error("Unauthorized (provjeri user/pass)");
    }

    return res;
  }

  function tokenLinks(token) {
    const accept = `${location.origin}/accept?token=${encodeURIComponent(token)}`;
    const decline = `${location.origin}/decline?token=${encodeURIComponent(token)}`;
    return `
      <div class="small"><a href="${accept}" target="_blank">accept</a></div>
      <div class="small"><a href="${decline}" target="_blank">decline</a></div>
    `;
  }

  async function loadEvents() {
    setMsg("Učitavanje...");
    const status = document.getElementById("status").value;
    const q = document.getElementById("q").value.trim();

    const params = new URLSearchParams();
    if (status) params.set("status", status);
    if (q) params.set("q", q);

    const res = await apiFetch(`/admin/api/events?${params.toString()}`);
    const data = await res.json();
    const items = data.items || [];

    const tbody = document.getElementById("tbody");
    tbody.innerHTML = "";

    for (const e of items) {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${e.id}</td>
        <td>${pill(e.status)}</td>
        <td>${e.first_name} ${e.last_name}</td>
        <td>${e.wedding_date || ""}</td>
        <td>${e.venue || ""}</td>
        <td>${e.guest_count ?? ""}</td>
        <td>
          <div>${e.email}</div>
          <div class="muted">${e.phone || ""}</div>
        </td>
        <td>${tokenLinks(e.token)}</td>
        <td>
          <div class="actions">
            <button data-action="accept" data-id="${e.id}" ${e.status==="accepted" ? "disabled" : ""}>Accept</button>
            <button data-action="decline" data-id="${e.id}" ${e.status==="declined" ? "disabled" : ""}>Decline</button>
          </div>
        </td>
      `;
      tbody.appendChild(tr);
    }

    // bind actions
    tbody.querySelectorAll("button[data-action]").forEach(btn => {
      btn.addEventListener("click", async () => {
        const id = btn.getAttribute("data-id");
        const action = btn.getAttribute("data-action");
        if (!id || !action) return;

        if (!confirm(`Sigurno? ${action.toUpperCase()} event #${id}`)) return;

        try {
          setMsg("Šaljem...");
          const r = await apiFetch(`/admin/api/events/${id}/${action}`, { method: "POST", body: "{}" });
          await r.json();
          setMsg("OK", "ok");
          await loadEvents();
        } catch (err) {
          setMsg(String(err), "error");
        }
      });
    });

    setMsg(`Učitano: ${items.length}`, "ok");
  }

  document.getElementById("refreshBtn").addEventListener("click", () => loadEvents());
  document.getElementById("logoutBtn").addEventListener("click", () => {
    localStorage.removeItem("admin_basic_auth");
    location.reload();
  });

  (async () => {
    try {
      await ensureAuth();
      await loadEvents();
    } catch (e) {
      setMsg(String(e), "error");
    }
  })();
</script>
</body>
</html>
